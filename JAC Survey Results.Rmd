---
title: "Aquatic Survey Results"
author: "K. Meyer, K. Bosley"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# General notes - choose color-blind friendly palette, inlcude number of response stats for each question

# tabulate the number of people by geo area relative to census data - how far off the mark?

##Tables and Figures to Include:

# 7.) have you used an aquatic facility in last 2 years?
      # - keep as pie chart
# 8.) which ones did you use?
      # - ordered bar chart (high to low) as percentages
      # - include list of the 'other'
# 9.) how often do you use an aquatic facility?
      # - keep as pie chart w/custom color palette and percentages on chart
# 10.) aquatic amenities
      # - keep as bar chart, reverse order overall
      # - produce age-based figures as well, may not use in presentation
      # - select top 5 per age group
      # - work on a way to bin household ages (mean household age) - if we have time??
# 11.) Non aquatic - exactly the same as above
      # 
# 12.) How much more would you use an aquatic facility, if amenities?
      # include pie chart 
      # also include chart with comparison to current useage (bar chart with two colors to show before and after)
# 13.) non-aquatic amenities
      # include pie chart
      # include before and after chart as well - probably not
      # 
      # what the survey does and doesn't show here
# 14.) tax Q
      # include as pie-chart w/percentages (raw, unweighted)
      # bar chart by geographic area 
      # (don't need this for report) bar chart by person responding to represent voting status?
      # weighted pie-chart overall??
      # link this to other questions (especially vs support question)

 are there other categories that matter and/or other ways to weight the data?
 
 


```{r}
# load libraries
library(dplyr)
library(gt)
library(ggplot2)
library(here)
library(viridis)
library(webshot)
```

## Load and filter data for analysis

```{r}
survey.dat <- read.csv(here("data",'JAC_Survey_3.23.25.csv'))

# replace column names
colnames.og <- colnames(survey.dat) 
colnames.new <- c("Response.ID","IP.address","User.agent","Response.status","Survey.URL","Start.time","Completion.time","Time.taken",
                          "Collector","JeffCo.resident","City.area","Age","Under7","7_12","13_18","19_34","35_54","55-64","65_74","75_older","RateNewPoolImportance",
                          "Under7_Non.swimmer","Under7_Beginner","Under7_Intermediate","Under7_Advanced",
                          "7_12_Non.swimmer","7_12_Beginner","7_12_Intermediate","7_12_Advanced",
                          "13_18_Non.swimmer","13_18_Beginner","13_18_Intermediate","13_18_Advanced",
                          "19_34_Non.swimmer","19_34_Beginner","19_34_Intermediate","19_34_Advanced",
                          "35_54_Non.swimmer","35_54_Beginner","35_54_Intermediate","35_54_Advanced",
                          "55-64_Non.swimmer","55-64_Beginner","55-64_Intermediate","55-64_Advanced",
                          "65_74_Non.swimmer","65_74_Beginner","65_74_Intermediate","65_74_Advanced",
                          "75_older_Non.swimmer","75_older_Beginner","75_older_Intermediate","75_older_Advanced","UsedAquaticsPast2Years",
                          "WhichAquaticFacilities","FacilityUsageRate","AquaAmenities_LapSwimming","AquaAmenities_OpenSwim","AquaAmenities_YouthLessons",
                          "AquaAmenities_AdultLessons","AquaAmenities_CompetitiveSwim","AquaAmenities_LifeguardTrain","AquaAmenities_Aerobics",
                          "AquaAmenities_SyncroSwim","AquaAmenities_SportsLeagues","AquaAmenities_SafetyTrain","AquaAmenities_Therapeutic",
                          "AquaAmenities_PartyRental","AquaAmenities_ParentChild","AquaAmenities_Sauna","AquaAmenities_HotTub","AquaAmenities_PublicShower",
                          "AquaAmenities_OutdoorPool","AquaAmenities_SplashPark","AquaAmenities_UsageRate","RecAmenities_AfterschoolCamps",
                          "RecAmenities_Preschool","RecAmenities_Childcare","RecAmenities_Playgroups","RecAmenities_FitnessClass","RecAmenities_PhysTherapy",
                          "RecAmenities_EventSpace","RecAmenities_WellnessClass","RecAmenities_Kitchen","RecAmenities_Cafe","RecAmenities_Gym",
                          "RecAmenities_OutPickleball","RecAmenities_InPickleball","RecAmenities_RockClimb","RecAmenities_TeenFit","RecAmenities_TeenCenter",
                          "RecAmenities_UsageRate","TaxSupport","Comments")

### Set Column Names and Remove Non-resident/tourist surveys
ResidentSurvey.dat <- survey.dat %>%
                        {cbind(.[, 1:93], .[, 123])} %>%
                        filter(Do.you.live.in.Jefferson.County.!="No, I am visiting")%>%
                        setNames(colnames.new)

# create nonresident survey data frame for future analysis
NonResidentSurvey.dat <- survey.dat %>%
                        {cbind(.[, 1:93], .[, 123])} %>%
                        filter(Do.you.live.in.Jefferson.County.=="No, I am visiting")%>%
                        setNames(colnames.new)

# save comments and survey ID as separate data frame for later
Comment.dat <- ResidentSurvey.dat %>%
                  select(Response.ID,Comments)

# drop the comment column in working data frame
ResidentSurvey.dat <- ResidentSurvey.dat[, -c(3,5:9,123)] 


```

# 1.) Summary of responses/what's presented: Include table w/residency status. Total # submissions (include completes and partials), removed non-resident/visitor (include #) surveys for this purpose 

```{r}

Res.responses <- as.data.frame(table(ResidentSurvey.dat$Response.status))
Nonres.responses <- as.data.frame(table(NonResidentSurvey.dat$Response.status))

Total.responses <- data.frame(Res.responses$Var1,Res.responses$Freq,Nonres.responses$Freq)
colnames(Total.responses) <- c("Survey Status","Resident","Non-resident")
data <- Total.responses
num.rows <- dim(data)[1]


# create a table using gt package
# Create a styled table with the required bold and grey lines
table_gt <- data %>%
  gt() %>%
  # Left-justify the first/row label column data
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_body(columns = colnames(data)[1])
  ) %>%
  # Left-justify the first/row label column name
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_column_labels(columns = colnames(data)[1])
  ) %>%
   # Center the rest of the table data 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body(columns = colnames(data)[2:length(colnames(data))])
  ) %>%
  # Center the rest of the table column names
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_column_labels(columns = colnames(data)[2:length(colnames(data))])
  ) 

# 
# Save the table as an HTML file first
gtsave(table_gt, here::here("tables", "SurveyStatusTable.html"))

# Convert the HTML table to a PNG file
webshot(here::here("tables", "SurveyStatusTable.html"), here::here("tables", "SurveyStatusTable.png"))

# Save as RTF as an alternative, which may be easier to edit in document
gtsave(table_gt, here::here("tables","SurveyStatusTable.rtf"))

```


```
### 2.) Make histogram of duplicate IP's, state the ways we limited the survey responses (one per device and CAPTCHA) 

```{r}

ip_freq <- table(ResidentSurvey.dat$IP.address)

# Convert the frequency table to a data frame
ip_freq_df <- as.data.frame(ip_freq)
colnames(ip_freq_df) <- c("IP.address", "Frequency")

# Plot the histogram using ggplot
ggplot(ip_freq_df, aes(x = Frequency)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  labs(x = "IP address replicates", y = "Frequency") +
  theme_minimal()
  
# Count the frequency of each unique IP address
ip_freq <- table(ResidentSurvey.dat$IP.address)

# Count how many IP addresses were seen 1 time, 2 times, etc.
freq_count <- table(ip_freq)

# Convert the result to a data frame
freq_count_df <- as.data.frame(freq_count)
colnames(freq_count_df) <- c("Times_seen", "Number_of_IPs")


```


## Question 3. In which city or area do you live?
# 3.) In which area do you live Q
         To DO:
          # - include table of residents by location and add column with 2020 census data by location
          # - reassign 'other' category (delete non-Jeffco, keep unassigned as 'other')
          # Create these figures by TOTAL HOUSEHOLD AGES
          # NOTE: Kevin provided a different number for the WEST END in and email
          # Explore different visualizations that include both geo area and responses on same figure, or multiple figures to break it up
```{r}
include census data from Kevin; he provided numbers from 2020 survey broken down by the same 
```

```{r}
# creates figure

# filter out 'other' category temporarily; need to go reclassify as possible
ResidentSurvey.dat <- ResidentSurvey.dat[!grepl("^Other \\(Please specify\\)", ResidentSurvey.dat$City.area), ]

# drop the blank entries
ResidentSurvey.dat <- filter(ResidentSurvey.dat, City.area != "")

# Count the occurrences of each unique 'City.area'
city_area_counts <- table(ResidentSurvey.dat$City.area)

# Convert the table to a data frame for ggplot
city_area_df <- as.data.frame(city_area_counts)
colnames(city_area_df) <- c("City.area", "Count")

# Create a bar plot with a colorblind-friendly palette
plot <- ggplot(city_area_df, aes(x = City.area, y = Count, fill = City.area)) +
  geom_bar(stat = "identity") +
  scale_color_viridis(discrete = TRUE) +  # Use a colorblind-friendly palette
  labs(title = "Number of Records for Each City Area",
       x = "City/Area",
       y = "Number of Responses") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels

print(plot)

# save figure with fixed dimensions to standardize w/others
ggsave(here("figures","city_area_plot.png"), plot = plot, width = 8, height = 6, units = "in", dpi = 300)


```

```{r}
# produces table of results

# Convert the table to a data frame for better handling
data <- as.data.frame(city_area_counts)
colnames(data) <- c("City.area", "Num.responses")

# create a table using gt package
# Create a styled table with the required bold and grey lines
table_gt <- data %>%
  gt() %>%
  cols_label(
    City.area = "City/Area",
    Num.responses = "Number of Responses"
  ) %>%
  # Left-justify the City/Area column data
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_body(columns = "City.area")
  ) %>%
  # Left-justify the "City/Area" column name
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_column_labels(columns = "City.area")
  ) %>%
  # Make column headers bold
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = c("City.area", "Num.responses"))
  ) %>%
  # Bold the line above the column headers (top of the table)
  tab_style(
    style = cell_borders(sides = "top", weight = 2),
    locations = cells_column_labels(columns = c("City.area", "Num.responses"))
  ) %>%
  # Bold the line below the column headers (under the header row)
  tab_style(
    style = cell_borders(sides = "bottom", weight = 2),
    locations = cells_column_labels(columns = c("City.area", "Num.responses"))
  ) %>%
  # Bold the bottom line of the table (under the last row of data)
  tab_style(
    style = cell_borders(sides = "bottom", weight = 2),
    locations = cells_body(rows = nrow(city_area_df), columns = c("City.area", "Num.responses"))
  ) 

# Save the table as an HTML file first
gtsave(table_gt, here::here("tables", "City_Area_Table.html"))

# Convert the HTML table to a PNG file
webshot(here::here("tables", "City_Area_Table.html"), here::here("tables", "City_Area_Table.png"), vwidth = 800, vheight = 600)
```

# 4.) What is your age?
        TO DO LIST
        # - re-do as bar plot (percentage - scale to 100)
        # - table of column sums across age groups, county-wide - include data on age distribution from census data
        # require some manual review/edits - adjust non-numeric entries
        # also include a figure that displays ALL of the people in a household
        # SWITCH TO 2024 ESTIMATE Data
```{r}
# 
# read-in Age Census Data and summarize to align with survey age bins
age_census <- read.csv(here("data","AquaticsSurveyAgeGroup_AllData.csv"))

# Summarize age census data based on these bins
age_summary <- data.frame(
  Age = c("15-19","18-34*", "35-54", "55-64", "65-74", "75+"),
  Census_2020 = c(sum(age_census$X2020.Census[age_census$Age.Group %in% c("15_19")]),
                   sum(age_census$X2020.Census[age_census$Age.Group %in% c("18_24", "25_29", "30_34")]), 
                   sum(age_census$X2020.Census[age_census$Age.Group %in% c("35_39", "40_44", "45_49", "50_54")]), 
                   sum(age_census$X2020.Census[age_census$Age.Group %in% c("55_59", "60_64")]), 
                   sum(age_census$X2020.Census[age_census$Age.Group %in% c("65_69", "70_74")]), 
                   sum(age_census$X2020.Census[age_census$Age.Group %in% c("75_79", "80_84", "85+")])
  ),
  OFM.Est_2024 = c(sum(age_census$X2024.OFM.Estimate[age_census$Age.Group %in% c("15_19")]), 
                    sum(age_census$X2024.OFM.Estimate[age_census$Age.Group %in% c("18_24", "25_29", "30_34")]),
                    sum(age_census$X2024.OFM.Estimate[age_census$Age.Group %in% c("35_39", "40_44", "45_49", "50_54")]), 
                    sum(age_census$X2024.OFM.Estimate[age_census$Age.Group %in% c("55_59", "60_64")]), 
                    sum(age_census$X2024.OFM.Estimate[age_census$Age.Group %in% c("65_69", "70_74")]), 
                    sum(age_census$X2024.OFM.Estimate[age_census$Age.Group %in% c("75_79", "80_84", "85+")])
  )
)

# summarise and format age distribution data

# drop the blank entries
ResidentSurvey.dat <- filter(ResidentSurvey.dat, Age != "")

# Count the occurrences of each unique 'City.area'
age_counts <- as.data.frame(table(ResidentSurvey.dat$Age))
colnames(age_counts) <- c("Age", "Respondents")
age_counts <- age_counts %>%
 mutate(Age = as.character(Age),  # Convert to character
         Age = ifelse(Age == "18-34", "18-34*", Age))  # Modify the specific row

# add columns of census data, and row where categories don't overlap perfectly
data <- age_counts %>%
          merge(age_summary, by = "Age")%>%
          #calculate proprtions by category
          mutate(SurveyProportion = round(Respondents/sum(Respondents),digits = 2))%>%
          mutate(CensusProportion = round(Census_2020/sum(Census_2020),digits=2))%>%
          mutate(CensusProportion_2024 = round(OFM.Est_2024/sum(OFM.Est_2024),digits=2))%>%
          #drop 2024 OFM estimates for simplicity?
          select(Age,Respondents,Census_2020,SurveyProportion,CensusProportion)

```
        
```{r}
# creates figure

# Create a bar plot with a colorblind-friendly palette
data_long <- data %>%
  pivot_longer(cols = c(SurveyProportion, CensusProportion),
               names_to = "ProportionType", 
               values_to = "Proportion")

# Create the plot
plot <- ggplot(data_long, aes(x = Age, y = Proportion, fill = ProportionType)) +
  geom_bar(stat = "identity", position = "dodge") +  # Dodge to separate the bars
  scale_fill_viridis(discrete = TRUE) +  # Colorblind-friendly palette
  labs(title = "Survey Responses vs 2020 Census Data by Age Range",
       x = "Age Range",
       y = "Proportion",
       fill = "Proportion Type") +  # Add a legend title for clarity
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels

# Print the plot
print(plot)

# save figure with fixed dimensions to standardize w/others
ggsave(here("figures","Age_Distribution_Fig.png"), plot = plot, width = 8, height = 6, units = "in", dpi = 300)

```
        
        
```{r}

# create a table using gt package
# Create a styled table with the required bold and grey lines
table_gt <- data %>%
  gt() %>%
  cols_label(
    Age = "Age",
    Respondents = "Responses",
    Census_2020 = "2020 Census",
    SurveyProportion = "Survey Proportion",
    CensusProportion = "Census Proportion"
  ) %>%
  # Left-justify the Age column data
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body(columns = c("Age", "Respondents","Census_2020","SurveyProportion","CensusProportion"))
  ) %>%
  # Left-justify the "Age" column name
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_column_labels(columns = c("Age", "Respondents","Census_2020","SurveyProportion","CensusProportion"))
  ) %>%
  # Make column headers bold
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = c("Age", "Respondents","Census_2020","SurveyProportion","CensusProportion"))
  ) %>%
  # Bold the line above the column headers (top of the table)
  tab_style(
    style = cell_borders(sides = "top", weight = 2),
    locations = cells_column_labels(columns = c("Age", "Respondents","Census_2020","SurveyProportion","CensusProportion"))
  ) %>%
  # Bold the line below the column headers (under the header row)
  tab_style(
    style = cell_borders(sides = "bottom", weight = 2),
    locations = cells_column_labels(columns = c("Age", "Respondents","Census_2020","SurveyProportion","CensusProportion"))
  ) %>%
  # Bold the bottom line of the table (under the last row of data)
  tab_style(
    style = cell_borders(sides = "bottom", weight = 2),
    locations = cells_body(rows = nrow(data), columns = c("Age", "Respondents","Census_2020","SurveyProportion","CensusProportion"))
  ) 

# Save the table as an HTML file first
gtsave(table_gt, here::here("tables", "Age_Distribution_Data.html"))

# Convert the HTML table to a PNG file
webshot(here::here("tables", "Age_Distribution_Data.html"), here::here("tables", "Age_Distribution_Data.png"), vwidth = 800, vheight = 600)



```


# 5.) how important is it to you to have an aquatic facility?
      # - barplot (percentages) w/table (numbers and percentages)
      
```{r}

#remove skipped responses
Q5.dat <- filter(ResidentSurvey.dat,RateNewPoolImportance !="")

Pool.Importance <- table(Q5.dat$RateNewPoolImportance)
Pool.Importance <- as.data.frame(Pool.Importance)
colnames(Pool.Importance) <- c("ImportanceRank","Frequency")

# Reorder by the frequency (from most to least frequent)
# Sort by Frequency in descending order and reorder ImportanceRank
Pool.Importance <- Pool.Importance %>%
  arrange(desc(Frequency)) %>%
  mutate(ImportanceRank = factor(ImportanceRank, levels = ImportanceRank))


# Create the plot
plot <- ggplot(Pool.Importance, aes(x = ImportanceRank, y = Frequency, fill = "ImportanceRank")) +
  geom_bar(stat = "identity", position = "dodge") +  # Dodge to separate the bars
  scale_fill_viridis(discrete = TRUE) +  # Colorblind-friendly palette
  labs(title = "Question 5: Ranking Pool Importance",
       x = "",
       y = "Frequency",
       fill = "Level of Importance") +  # Add a legend title for clarity
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12,angle = 45, hjust = 1))  # Rotate x-axis labels

# Print the plot
print(plot)


```
      

# 6.) swimming ability question
      # - sum across each age group and swimming ability category
      # - create bar chart w/ percentages within each age category (stacked bar chart)
      # - include national data on swimming ability?      

```{r}
# summarize the data
library(reshape2)
Q6.dat <- ResidentSurvey.dat[,16:47]
Q6.dat <- colSums(Q6.dat,na.rm=TRUE)

# Reshape the data from wide to long format
AgeAbility <- names(Q6.dat)
long.data <- melt(Q6.dat)

#merge into a new data frame
AgeAbility.dat <- data.frame(AgeAbility,long.data$value)

# need to rename some of the AgeAbility variables so ages can be more easily separated from ability
AgeAbility.dat <- AgeAbility.dat %>%
  mutate(AgeAbility = recode(AgeAbility,
    "Under7_Non.swimmer" = "Under7_Non.swimmer",
    "Under7_Beginner" = "Under7_Beginner",
    "Under7_Intermediate" = "Under7_Intermediate",
    "Under7_Advanced" = "Under7_Advanced",
    "7_12_Non.swimmer" = "7.12_Non.swimmer",
    "7_12_Beginner" = "7.12_Beginner",
    "7_12_Intermediate" = "7.12_Intermediate",
    "7_12_Advanced" = "7.12_Advanced",
    "13_18_Non.swimmer" = "13.18_Non.swimmer",
    "13_18_Beginner" = "13.18_Beginner",
    "13_18_Intermediate" = "13.18_Intermediate",
    "13_18_Advanced" = "13.18_Advanced",
    "19_34_Non.swimmer" = "19.34_Non.swimmer",
    "19_34_Beginner" = "19.34_Beginner",
    "19_34_Intermediate" = "19.34_Intermediate",
    "19_34_Advanced" = "19.34_Advanced",
    "35_54_Non.swimmer" = "35.54_Non.swimmer",
    "35_54_Beginner" = "35.54_Beginner",
    "35_54_Intermediate" = "35.54_Intermediate",
    "35_54_Advanced" = "35.54_Advanced",
    "55_64_Non.swimmer" = "55.64_Non.swimmer",
    "55_64_Beginner" = "55.64_Beginner",
    "55_64_Intermediate" = "55.64_Intermediate",
    "55_64_Advanced" = "55.64_Advanced",
    "65_74_Non.swimmer" = "65.74_Non.swimmer",
    "65_74_Beginner" = "65.74_Beginner",
    "65_74_Intermediate" = "65.74_Intermediate",
    "65_74_Advanced" = "65.74_Advanced",
    "75_older_Non.swimmer" = "75.older_Non.swimmer",
    "75_older_Beginner" = "75.older_Beginner",
    "75_older_Intermediate" = "75.older_Intermediate",
    "75_older_Advanced" = "75.older_Advanced"
  ))


# Split the variable name into AgeGroup and SwimmingAbility
AgeAbility.df <- AgeAbility.dat %>%
  separate(AgeAbility, into = c("AgeGroup", "SwimmingAbility"), sep = "_") %>%
  rename(Number = long.data.value)

# View the resulting data frame
head(AgeAbility.df)

# Calculate proportions within each AgeGroup
AgeAbility.df <- AgeAbility.df %>%
  group_by(AgeGroup) %>%
  mutate(Proportion = Number / sum(Number))

# Reorder AgeGroup to ensure "Under7" comes first, followed by "7.12", then the rest
AgeAbility.df$AgeGroup <- factor(AgeAbility.df$AgeGroup, 
                                 levels = c("Under7", "7.12","13.18","19.34","35.54","55-64","65.74",    "75.older"))

# Reorder SwimmingAbility to ensure 'Non.swimmer' is first, followed by 'Beginner', 'Intermediate', and 'Advanced'
AgeAbility.df$SwimmingAbility <- factor(AgeAbility.df$SwimmingAbility, 
                                        levels = c("Advanced","Intermediate","Beginner", "Non.swimmer"))

# Create the bar plot with proportions and the reordered x-axis
plot <- ggplot(AgeAbility.df, aes(x = AgeGroup, y = Proportion, fill = SwimmingAbility)) +
  geom_bar(stat = "identity") +  # use stat = "identity" to plot proportions directly
  scale_fill_viridis(discrete = TRUE) +
  labs(y = "Proportion", title = "Proportions by Age Group and Swimming Ability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

      